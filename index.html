<!DOCTYPE html>
<html>

<head>
    <title>Enkodo</title>
</head>

<body>
    <h1>Enkodo - RSA Encrypting</h1>

    <label for="keySize">Select size of key:</label>
    <select id="keySize">
        <option value="256">256</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="2048">2048</option>
    </select>

    <button onclick="generateKeys()">Generate Keys</button>
    <br>
    <label>Public Key</label>
    <label for="npublic">n:</label>
    <textarea id="npublic" rows="4" cols="60"></textarea>
    <label for="e">e:</label>
    <textarea id="e" rows="4" cols="60"></textarea>

    <br>
    <label for="private Key">Private Key</label>
    <label for="nprivate">n:</label>
    <textarea id="nprivate" rows="4" cols="60"></textarea>

    <label for="d">d:</label>
    <textarea id="d" rows="4" cols="60"></textarea>

    <br>
    <label for="inputdata">Plain Text:</label>
    <textarea id="inputdata" rows="7" cols="100" maxlength="3500"></textarea>
    <br>
    <button onclick="encryptData()">Encrypt Data</button>
    <button onclick="decryptData()">Decrypt Data</button>
    <br>
    <label for="encryptedData">Encrypted Data:</label>
    <textarea id="encryptedData" rows="10" cols="100" readonly></textarea>
    <button onclick="decyptThisData()">Decrypt this Data</button>
    <br>
    <label for="decryptedData">Decrypted Data:</label>
    <textarea id="decryptedData" rows="7" cols="100" readonly></textarea>

    <script src="PrimeNumber.js"> </script>

    <script src="MyMath.js"></script>

    <script src="Key.js"></script>

    <script src="Convert.js"></script>

    <script>
        let publicKey, privateKey;

        // Hàm xử lý khi người dùng nhấn nút Generate Keys
        function generateKeys() {
            const keySize = Number(document.getElementById('keySize').value);
            generateRSAKeyPair(keySize);
            document.getElementById('npublic').value = publicKey.n;
            document.getElementById('e').value = publicKey.e;
            document.getElementById('nprivate').value = privateKey.n;
            document.getElementById('d').value = privateKey.d;
        }

        // Hàm mã hóa dữ liệu sử dụng khóa công khai RSA
        function encrypt(publicKey, data) {
            const e = publicKey.e,
                n = publicKey.n;
            const encryptedData = data.split('').map(char => powerMod(BigInt(char.charCodeAt(0)), BigInt(e), BigInt(n)));
            return encryptedData;
        }

        let encryptedData

        function publicKeys() {
            n = document.getElementById('npublic').value;
            e = document.getElementById('e').value;
            publicKey = {
                n: n,
                e: e
            };
        }

        function privateKeys() {
            n = BigInt(document.getElementById('nprivate').value);
            d = BigInt(document.getElementById('d').value);
            privateKey = {
                n: n,
                d: d
            };
        }

        function getKeys() {
            publicKeys()
            privateKeys()
        }

        // Hàm xử lý khi người dùng nhấn nút Encrypt Data
        function encryptData() {
            if (document.getElementById('npublic').value === "" && document.getElementById('e').value === "")
                generateKeys()
            else {
                getKeys();
            }
            const inputData = document.getElementById('inputdata').value;
            encryptedData = encrypt(publicKey, inputData);
            document.getElementById('encryptedData').value = (encodeBase64(encryptedData)).join('\n\n');
        }

        // Hàm giải mã RSA
        function decrypt(encryptedData, key) {
            const d = key.d;
            const n = key.n;
            const result = [];
            try {
                console.log(encryptedData[0])
                for (const char of encryptedData) {
                    result.push(String.fromCharCode(Number(powerMod(char, d, n))));
                }
                return result.join('');
            }
            catch (error) {
                alert("Private key may not suitable with this data!")
            }
        }

        function decyptThisData() {
            privateKeys()
            if (privateKey.n === "" || privateKey.d === "") {
                alert("Required fields missing.")
            }
            encryptedData = decodeBase64((document.getElementById('encryptedData').value).split("\n\n"))
            const decryptedData = decrypt(encryptedData, privateKey);
            document.getElementById('decryptedData').value = decryptedData;
        }

        function isBase64(inputString) {
            return (/[a-zA-Z]/.test(inputString) && /\d/.test(inputString)) || /[a-zA-Z]/.test(inputString);
        }

        // Hàm xử lý khi người dùng nhấn nút Decrypt Data
        function decryptData() {
            privateKeys()
            encryptedData = (document.getElementById('inputdata').value).split("\n");
            if (privateKey.n === "" || privateKey.d === "" || encryptedData === "") {
                alert("Required fields missing.")
            } else {
                if (isBase64(encryptedData)) {
                    encryptedData = decodeBase64(encryptedData);
                }
                let decryptedData = decrypt(encryptedData, privateKey);
                document.getElementById('decryptedData').value = decryptedData;
            }
        }
    </script>
</body>

</html>
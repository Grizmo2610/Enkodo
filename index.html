<!DOCTYPE html>
<html>

<head>
    <title>Enkodo</title>
</head>

<body>
    <h1>Enkodo - RSA Encrypting</h1>

    <label for="keySize">Select size of key:</label>
    <select id="keySize">
        <option value="256">256</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="2048">2048</option>
    </select>

    <button onclick="generateKeys()">Generate Keys</button>
    <br>
    <label>Public Key</label>
    <label for="npublic">n:</label>
    <textarea id="npublic" rows="4" cols="60"></textarea>
    <label for="e">e:</label>
    <textarea id="e" rows="4" cols="60"></textarea>

    <br>
    <label for="private Key">Private Key</label>
    <label for="nprivate">n:</label>
    <textarea id="nprivate" rows="4" cols="60"></textarea>

    <label for="d">d:</label>
    <textarea id="d" rows="4" cols="60"></textarea>

    <br>
    <label for="plaintext">Plain Text:</label>
    <textarea id="plaintext" rows="7" cols="100" maxlength="3500"></textarea>
    <br>
    <button onclick="encryptData()">Encrypt Data</button>
    <button onclick="decryptData()">Decrypt Data</button>
    <br>
    <label for="encryptedData">Encrypted Data:</label>
    <textarea id="encryptedData" rows="10" cols="100"></textarea>
    <br>
    <label for="decryptedData">Decrypted Data:</label>
    <textarea id="decryptedData" rows="7" cols="100" readonly></textarea>

    <script src="PrimeNumber.js"> </script>

    <script src="MyMath.js"></script>

    <script src="Key.js"></script>

    <script src="Convert.js"></script>

    <script>
        let publicKey, privateKey;

        // Hàm xử lý khi người dùng nhấn nút Generate Keys
        function generateKeys() {
            const keySize = Number(document.getElementById('keySize').value);
            generateRSAKeyPair(keySize);
            document.getElementById('npublic').value = publicKey.n;
            document.getElementById('e').value = publicKey.e;
            document.getElementById('nprivate').value = privateKey.n;
            document.getElementById('d').value = privateKey.d;
        }

        // Hàm mã hóa dữ liệu sử dụng khóa công khai RSA
        function encrypt(publicKey, data) {
            const e = publicKey.e,
                n = publicKey.n;
            const encryptedData = data.split('').map(char => powerMod(BigInt(char.charCodeAt(0)), BigInt(e), BigInt(n)));
            return encryptedData;
        }

        let encryptedData

        function getKeys() {
            n = document.getElementById('npublic').value;
            e = document.getElementById('e').value;
            publicKey = {
                n: n,
                e: e
            };

            n = document.getElementById('nprivate').value;
            d = document.getElementById('d').value;
            privateKey = {
                n: n,
                d: d
            };
        }

        // Hàm xử lý khi người dùng nhấn nút Encrypt Data
        function encryptData() {
            if (document.getElementById('npublic').value === "" && document.getElementById('e').value === "")
                generateKeys()
            else {
                getKeys();
            }
            const inputData = document.getElementById('plaintext').value;
            encryptedData = encrypt(publicKey, inputData);
            document.getElementById('encryptedData').value = (encodeBase64(encryptedData)).join('\n\nx');
        }

        // Hàm giải mã RSA
        function decrypt(encryptedData, key) {
            const d = key.d;
            const n = key.n;
            const result = [];
            const data = encryptedData
            try {
                for (const char of data) {
                    const decryptedChar = String.fromCharCode(Number(powerMod(char, d, n)));
                    result.push(decryptedChar);
                }
                return result.join('');
            }
            catch (error) {
                alert("Private key may not suitable with this data!")
            }
        }

        // Hàm xử lý khi người dùng nhấn nút Decrypt Data
        function decryptData() {
            if (encryptedData === undefined && document.getElementById('encryptedData')) {
                if (document.getElementById('plaintext').value === "") {
                    alert("Required fields missing.")
                }
                else {
                    encryptedData = document.getElementById('plaintext').value;
                }
            }
            else if (privateKey === undefined) {
                alert("Required Private Key.")
            }
            const decryptedData = decrypt(encryptedData, privateKey);
            document.getElementById('decryptedData').value = decryptedData;
        }
    </script>
</body>

</html>